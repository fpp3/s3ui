
// RunningActivity animated screen test using PCF8814 and Display wrapper

#include <Arduino.h>
#include "s3ui.h"
#include "PCF8814.h"
#include "Fonts/Picopixel.h"

static const unsigned char PROGMEM image_download_0_bits[] = {0x00,0x00,0x00,0x07,0xff,0xf0,0x04,0x00,0x10,0x03,0xff,0xe0,0x01,0x00,0x40,0x01,0x7f,0x40,0x01,0x7f,0x40,0x01,0x3e,0x40,0x00,0x9c,0x80,0x00,0x49,0x00,0x00,0x22,0x00,0x00,0x14,0x00,0x00,0x14,0x00,0x00,0x22,0x00,0x00,0x49,0x00,0x00,0x80,0x80,0x01,0x00,0x40,0x01,0x00,0x40,0x01,0x00,0x40,0x01,0x00,0x40,0x03,0xff,0xe0,0x04,0x00,0x10,0x07,0xff,0xf0,0x00,0x00,0x00};

static const unsigned char PROGMEM image_download_1_bits[] = {0x00,0x00,0x00,0x07,0xff,0xf0,0x04,0x00,0x10,0x03,0xff,0xe0,0x01,0x00,0x40,0x01,0x00,0x40,0x01,0x7f,0x40,0x01,0x3e,0x40,0x00,0x9c,0x80,0x00,0x49,0x00,0x00,0x22,0x00,0x00,0x14,0x00,0x00,0x14,0x00,0x00,0x22,0x00,0x00,0x49,0x00,0x00,0x80,0x80,0x01,0x08,0x40,0x01,0x3e,0x40,0x01,0x7f,0x40,0x01,0x00,0x40,0x03,0xff,0xe0,0x04,0x00,0x10,0x07,0xff,0xf0,0x00,0x00,0x00};

static const unsigned char PROGMEM image_download_2_bits[] = {0x00,0x00,0x00,0x07,0xff,0xf0,0x04,0x00,0x10,0x03,0xff,0xe0,0x01,0x00,0x40,0x01,0x00,0x40,0x01,0x00,0x40,0x01,0x3e,0x40,0x00,0x9c,0x80,0x00,0x49,0x00,0x00,0x22,0x00,0x00,0x14,0x00,0x00,0x14,0x00,0x00,0x22,0x00,0x00,0x49,0x00,0x00,0x80,0x80,0x01,0x3e,0x40,0x01,0x7f,0x40,0x01,0x7f,0x40,0x01,0x00,0x40,0x03,0xff,0xe0,0x04,0x00,0x10,0x07,0xff,0xf0,0x00,0x00,0x00};

static const unsigned char PROGMEM image_download_3_bits[] = {0x00,0x00,0x00,0x07,0xff,0xf0,0x04,0x00,0x10,0x03,0xff,0xe0,0x01,0x00,0x40,0x01,0x00,0x40,0x01,0x00,0x40,0x01,0x00,0x40,0x00,0x80,0x80,0x00,0x41,0x00,0x00,0x22,0x00,0x00,0x14,0x00,0x00,0x14,0x00,0x00,0x22,0x00,0x00,0x49,0x00,0x00,0x9c,0x80,0x01,0x3e,0x40,0x01,0x7f,0x40,0x01,0x7f,0x40,0x01,0x00,0x40,0x03,0xff,0xe0,0x04,0x00,0x10,0x07,0xff,0xf0,0x00,0x00,0x00};

static const unsigned char PROGMEM image_download_4_bits[] = {0x00,0x40,0x00,0x00,0xe0,0x00,0x01,0x40,0x00,0x02,0xa0,0x00,0x05,0x10,0x00,0x0a,0x08,0x00,0x14,0x08,0x00,0x28,0x08,0x00,0x50,0x08,0x00,0xe0,0x08,0x00,0x50,0x08,0x00,0x08,0x07,0xe0,0x07,0xe0,0x10,0x00,0x14,0x0a,0x00,0x17,0xe7,0x00,0x17,0xca,0x00,0x17,0x94,0x00,0x17,0x28,0x00,0x12,0x50,0x00,0x08,0xa0,0x00,0x05,0x40,0x00,0x02,0x80,0x00,0x07,0x00,0x00,0x02,0x00};

static const unsigned char PROGMEM image_download_5_bits[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x06,0x50,0x00,0x0a,0x5f,0x00,0xfa,0x50,0x81,0x0a,0x50,0x42,0x0a,0x50,0x24,0x0a,0x50,0x18,0x7a,0x50,0x03,0xfa,0x50,0x19,0xfa,0x50,0x24,0xfa,0x50,0x42,0x7a,0x50,0x81,0x0a,0x5f,0x00,0xfa,0x50,0x00,0x0a,0x60,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

static const unsigned char PROGMEM image_download_6_bits[] = {0x00,0x02,0x00,0x00,0x07,0x00,0x00,0x02,0x80,0x00,0x05,0x40,0x00,0x08,0xa0,0x00,0x10,0x50,0x00,0x10,0x28,0x00,0x13,0x94,0x00,0x17,0xca,0x00,0x17,0xe7,0x00,0x17,0xca,0x07,0xe0,0x10,0x08,0x07,0xe0,0x50,0x08,0x00,0xe0,0x08,0x00,0x50,0x08,0x00,0x28,0x08,0x00,0x14,0x08,0x00,0x0a,0x08,0x00,0x05,0x10,0x00,0x02,0xa0,0x00,0x01,0x40,0x00,0x00,0xe0,0x00,0x00,0x40,0x00};


// Animation frames array
static const uint8_t *animationFrames[] = {
  image_download_0_bits,
  image_download_1_bits,
  image_download_2_bits,
  image_download_3_bits,
  image_download_4_bits,
  image_download_5_bits,
  image_download_6_bits
};

static const uint8_t kNumFrames = sizeof(animationFrames) / sizeof(animationFrames[0]);
static const uint16_t kBitmapW = 24;
static const uint16_t kBitmapH = 24;
static const uint16_t kFrameDelayMs = 250;

// Pins for Nokia 1100 (PCF8814) display (SCE, SCLK, SDIN, RST)
static PCF8814 lcd(19, 18, 23, 21);
static s3ui ui;

// Test case structure for animated running activity
struct AnimatedActivityCase {
  const char* title;
  const char* caption;
};

static AnimatedActivityCase kCases[] = {
  // 1) No wrap (short text)
  {"Scanning 1/5", "Ready."},
  // 2) Wrap (long text)
  {"Scanning 2/5", "Finding channels and scanning spectrum occupancy to avoid interference. The following description should wrap into multiple lines below the bitmap to validate auto-wrap logic."},
  // 3) Explicit newline (\n)
  {"Scanning 3/5", "Calibrating\nScanning"},
  // 4) Carriage return (\r)
  {"Scanning 4/5", "Stage One\rStage Two"},
  // 5) Mixed long + newline
  {"Scanning 5/5", "Collecting samples and computing noise floor for adaptive channel selection.\nPlease wait..."}
};

static const uint8_t kNumCases = sizeof(kCases) / sizeof(kCases[0]);
static uint8_t currentCase = 0;
static unsigned long lastStep = 0;
static const uint16_t stepMs = 2000; // 2s per case

void setup() {
  // Initialize display
  lcd.begin();
  lcd.setContrast(0x0F); // Adjust if needed for your module
  lcd.displayOn();

  // Initialize wrapper and fonts
  ui.setDisplay(&lcd, 96, 65);
  ui.setTitleFont(&Picopixel);
  ui.setContentFont(&Picopixel);
  ui.setTitleSize(1);
  ui.setContentSize(1);

  // Initial render: first case
  ui.runningActivityScreen(kCases[currentCase].title, "98%", animationFrames, kNumFrames, kBitmapW, kBitmapH, kFrameDelayMs, kCases[currentCase].caption);
  lcd.display();
}

void loop() {
  // Update animation frames
  ui.update();
  lcd.display();
  
  // Small delay to prevent overwhelming the MCU
  delay(10);

  // Cycle through cases to demonstrate no-wrap, wrap, and newline handling
  unsigned long now = millis();
  if (now - lastStep >= stepMs) {
    lastStep = now;

    currentCase++;
    if (currentCase >= kNumCases) {
      currentCase = 0;
    }

    ui.runningActivityScreen(kCases[currentCase].title, "98%", animationFrames, kNumFrames, kBitmapW, kBitmapH, kFrameDelayMs, kCases[currentCase].caption);
    lcd.display();
  }
}